# V12.2 변경사항 - 프로세스 중복 실행 방지

## 날짜
2026-01-14

## 문제점
1월 13일 18:01 이후 시스템이 정지되어 1월 14일 오전부터 실행되지 않음
- **근본 원인**: 4개의 중복 pythonw.exe 프로세스 (PID: 41800, 41828, 42768, 42804) 실행
- **증상**: 18:01 이후 로그 기록 없음 (20시간 동안 정지)
- **복구**: 사용자가 14:48에 수동으로 재시작

## 해결 방안
### Phase 1: 프로세스 락 구현 (필수) ✅ 완료

프로세스 중복 실행을 방지하는 락 파일 메커니즘 구현

## 구현 내역

### 1. main.py 수정

#### A. 임포트 추가
```python
import os  # PID 확인용
```

#### B. EcountAutomationOrchestrator 클래스 수정

**초기화 메서드 (`__init__`)**:
- 프로세스 락 파일 (`runtime.lock`) 경로 설정
- `acquire_lock()` 호출하여 중복 실행 방지
- 이미 실행 중인 프로세스가 있으면 종료 (sys.exit(1))

**새로운 메서드**:

1. **`acquire_lock(self)`**:
   - 락 파일 존재 여부 확인
   - 존재하면 파일에 저장된 PID 읽기
   - Windows `tasklist` 명령으로 해당 PID 프로세스 실행 여부 확인
   - 프로세스가 실행 중이면 False 반환 (중복 실행 차단)
   - 프로세스가 없으면 오래된 락 파일 삭제
   - 현재 프로세스 PID로 새 락 파일 생성
   - True 반환 (실행 허용)

2. **`release_lock(self)`**:
   - 프로그램 종료 시 락 파일 삭제
   - 다음 실행을 위해 정리

**run 메서드 수정**:
- 최상위 try-finally 블록 추가
- finally 블록에서 `release_lock()` 호출
- 비정상 종료 시에도 락 파일 확실히 삭제

### 2. .gitignore 수정

런타임 파일 제외:
```
runtime.lock
heartbeat.txt
```

### 3. 테스트 스크립트 생성

`test_process_lock.py`:
- 첫 번째 인스턴스 생성 성공 확인
- 두 번째 인스턴스 생성 차단 확인 (SystemExit)
- 락 해제 후 새 인스턴스 생성 성공 확인

## 작동 원리

1. **프로그램 시작**:
   ```
   EcountAutomationOrchestrator() 생성
   → acquire_lock() 호출
   → runtime.lock 파일 확인
   ```

2. **중복 실행 시도**:
   ```
   새로운 인스턴스 생성 시도
   → acquire_lock() 호출
   → runtime.lock 파일 발견
   → PID 읽기 및 프로세스 확인
   → 실행 중인 프로세스 발견
   → False 반환
   → sys.exit(1) - 프로그램 종료
   ```

3. **정상 종료**:
   ```
   프로그램 종료 (Ctrl+C 또는 정상 종료)
   → run() 메서드의 finally 블록 실행
   → release_lock() 호출
   → runtime.lock 파일 삭제
   ```

4. **비정상 종료**:
   ```
   프로그램 크래시 또는 강제 종료
   → 다음 실행 시 acquire_lock() 호출
   → 오래된 PID 확인
   → 프로세스가 없음을 확인
   → 오래된 락 파일 삭제
   → 새 락 파일 생성 - 실행 계속
   ```

## 테스트 방법

### 1. 단위 테스트
```bash
python test_process_lock.py
```

예상 출력:
```
======================================================================
프로세스 락 기능 테스트
======================================================================

1. 첫 번째 인스턴스 생성 시도...
   ✅ 첫 번째 인스턴스 생성 성공
   - 락 파일: runtime.lock
   - PID: 12345

2. 두 번째 인스턴스 생성 시도 (중복)...
   ✅ 중복 실행 방지 성공 (SystemExit 발생)
   - 두 번째 인스턴스 생성 차단됨

3. 락 해제 테스트...
   ✅ 락 파일 삭제 성공

4. 락 해제 후 새 인스턴스 생성 시도...
   ✅ 락 해제 후 새 인스턴스 생성 성공

======================================================================
테스트 완료: 모든 테스트 통과
======================================================================
```

### 2. 통합 테스트

**터미널 1**:
```bash
python main.py
# 또는
pythonw main.py
```

**터미널 2** (동시에):
```bash
python main.py
```

예상 결과:
```
❌ 이미 실행 중인 프로세스가 있습니다. 프로그램을 종료합니다.
```

로그 파일 확인:
```
[15:30:01] [ERROR] ❌ 이미 실행 중인 프로세스 (PID: 12345)
```

### 3. 복구 테스트

1. 프로그램 실행
2. 작업 관리자에서 강제 종료
3. runtime.lock 파일이 남아있는지 확인
4. 프로그램 재실행
5. 오래된 락 파일이 자동으로 삭제되고 새로 실행되는지 확인

## 예상 효과

✅ **중복 실행 방지**: 4개의 중복 프로세스 문제 해결
✅ **자원 관리**: CPU, 메모리, 브라우저 리소스 절약
✅ **안정성 향상**: 프로세스 충돌 방지
✅ **로그 품질**: 단일 프로세스에서 깨끗한 로그 생성

## 다음 단계 (Phase 2, 3 - 선택 사항)

### Phase 2: 하트비트 모니터링
- 프로세스 생존 여부를 주기적으로 기록
- watchdog 스크립트로 모니터링
- 프로세스 정지 감지 시 자동 재시작

### Phase 3: Windows 작업 스케줄러
- 매일 05:55 자동 재시작
- 안전장치 (failsafe)
- 날짜 변경 재시작 실패 시 대비

## 파일 변경 내역

- ✏️ `main.py` - 프로세스 락 기능 추가
- ✏️ `.gitignore` - runtime.lock, heartbeat.txt 제외
- ➕ `test_process_lock.py` - 테스트 스크립트
- ➕ `CHANGELOG_V12.2.md` - 이 파일

## 버전 정보

- **이전 버전**: V9.5 (V12.1)
- **현재 버전**: V12.2
- **주요 개선**: 프로세스 중복 실행 방지
