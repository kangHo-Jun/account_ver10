# V12.3 변경사항 - 하트비트 모니터링 및 자동 재시작

## 날짜
2026-01-14

## 개요
Phase 1 (프로세스 락)에 이어 Phase 2 (하트비트)와 Phase 3 (자동 재시작)를 구현하여 완전한 프로세스 안정성 시스템 구축

## Phase 2: 하트비트 모니터링 ✅

### 목적
프로세스가 살아있지만 응답하지 않는 "좀비" 상태 감지

### 구현 내용

#### 1. main.py - heartbeat() 메서드 추가

```python
def heartbeat(self):
    """프로세스 생존 신호 기록"""
    try:
        heartbeat_file = Path("heartbeat.txt")
        with open(heartbeat_file, 'w', encoding='utf-8') as f:
            f.write(f"{datetime.now().isoformat()}\n")
            f.write(f"PID: {os.getpid()}\n")
            f.write(f"Stats: {self.stats}\n")
    except Exception as e:
        logger.warning(f"[HEARTBEAT] 하트비트 기록 실패: {e}")
```

#### 2. main.py - while 루프에서 호출

```python
while True:
    # 프로세스 생존 신호 기록
    self.heartbeat()

    # 기존 로직...
```

**기록 내용**:
- ISO 형식 타임스탬프
- 현재 프로세스 PID
- 통계 정보 (total, success, failure, count, cancellations)

**기록 주기**:
- 업무 시간: 30분 간격 (사이클 실행 전마다)
- 업무 시간 외: 10분 간격 (대기 루프마다)

#### 3. watchdog.py - 감시 프로그램

**기능**:
- 5분마다 heartbeat.txt 파일 확인
- 60분 이상 업데이트 없으면 프로세스 정지로 판단
- 자동으로 프로세스 종료 및 재시작

**사용법**:
```bash
# 백그라운드 실행
pythonw watchdog.py

# 포그라운드 실행 (디버그용)
python watchdog.py
```

**출력 예시**:
```
======================================================================
하트비트 감시 프로그램 시작
- 체크 간격: 300초
- 타임아웃: 60분
======================================================================

[2026-01-14 15:45:00] [OK] 프로세스 정상 작동 (마지막 업데이트: 120초 전)
[2026-01-14 15:50:00] [OK] 프로세스 정상 작동 (마지막 업데이트: 420초 전)
```

**알림 조건**:
- 60분 이상 업데이트 없음 → 자동 재시작
- 3회 연속 에러 → 자동 재시작

## Phase 3: Windows 작업 스케줄러 ✅

### 목적
매일 05:55에 강제 재시작하여 로그 파일 갱신 및 시스템 안정성 보장

### 구현 내용

#### 1. restart_daily.bat

**기능**:
1. 모든 pythonw.exe 프로세스 종료
2. 5초 대기
3. runtime.lock 및 heartbeat.txt 정리
4. main.py 재시작
5. 실행 확인

**실행 로그**:
```
[2026-01-14 05:55:00] 일일 재시작 시작
[2026-01-14 05:55:00] 기존 프로세스 종료 완료
[2026-01-14 05:55:00] 5초 대기 중...
[2026-01-14 05:55:05] 락 파일 삭제 완료
[2026-01-14 05:55:05] 하트비트 파일 삭제 완료
[2026-01-14 05:55:05] 프로그램 재시작 중...
[2026-01-14 05:55:08] 재시작 성공
[2026-01-14 05:55:08] 일일 재시작 완료
```

#### 2. SCHEDULER_SETUP.md

상세한 Windows 작업 스케줄러 설정 가이드:
- 단계별 스크린샷 설명
- 트리거, 동작, 조건 설정
- 수동 테스트 방법
- 문제 해결 가이드

### 작업 스케줄러 설정 요약

- **이름**: ERP 자동화 일일 재시작
- **트리거**: 매일 오전 05:55
- **동작**: restart_daily.bat 실행
- **조건**: 절전 모드에서 해제하여 실행
- **권한**: 사용자 로그온 여부 무관

## 3단계 방어 시스템

### Level 1: 프로세스 락 (V12.2)
- **방어 대상**: 중복 실행
- **작동 시점**: 프로그램 시작 시
- **효과**: 4개 중복 프로세스 차단

### Level 2: 하트비트 모니터링 (V12.3)
- **방어 대상**: 프로세스 정지 (좀비 상태)
- **작동 시점**: 실시간 감시 (5분 간격)
- **효과**: 60분 무응답 시 자동 복구

### Level 3: 작업 스케줄러 (V12.3)
- **방어 대상**: 날짜 변경 재시작 실패
- **작동 시점**: 매일 05:55
- **효과**: 강제 재시작으로 안전장치

## 파일 변경 내역

### 수정된 파일
- ✏️ `main.py` - heartbeat() 메서드 추가, while 루프에서 호출
- ✏️ `.gitignore` - heartbeat.txt 제외 (이미 V12.2에서 추가됨)

### 새로 생성된 파일
- ➕ `watchdog.py` - 하트비트 감시 프로그램
- ➕ `restart_daily.bat` - 일일 재시작 배치 파일
- ➕ `SCHEDULER_SETUP.md` - 작업 스케줄러 설정 가이드
- ➕ `CHANGELOG_V12.3.md` - 이 파일

## 테스트 방법

### 1. 하트비트 기능 테스트

```bash
# 프로그램 실행
python main.py

# 다른 터미널에서 확인 (PowerShell)
while ($true) {
    Clear-Host;
    Get-Content heartbeat.txt;
    Start-Sleep 10
}
```

예상 출력:
```
2026-01-14T15:45:00.123456
PID: 12345
Stats: {'total': 5, 'success': 5, 'failure': 0, 'count': 23, 'cancellations': 0}
```

### 2. Watchdog 테스트

```bash
# 터미널 1: 메인 프로그램 실행
python main.py

# 터미널 2: Watchdog 실행
python watchdog.py
```

Watchdog 출력에서 `[OK] 프로세스 정상 작동` 확인

### 3. 배치 파일 테스트

```batch
# 관리자 권한 커맨드 프롬프트
cd C:\Users\DSAI\Desktop\회계_ERP
restart_daily.bat
```

재시작 성공 메시지 확인

### 4. 작업 스케줄러 테스트

1. SCHEDULER_SETUP.md 가이드에 따라 작업 생성
2. 작업 스케줄러에서 "실행" 클릭
3. logs/ 폴더에 새 로그 파일 생성 확인

## 운영 시나리오

### 정상 작동

```
06:00 - 업무 시작, 첫 사이클 실행
06:00 - heartbeat.txt 업데이트
06:30 - 두 번째 사이클 실행
06:30 - heartbeat.txt 업데이트
...
18:00 - 업무 종료
18:10 - heartbeat.txt 업데이트 (10분 간격)
...
다음날 05:55 - 작업 스케줄러로 재시작
다음날 06:00 - 새로운 날 시작, 사이클 실행
```

### 프로세스 정지 감지

```
14:00 - 마지막 정상 사이클
14:00 - heartbeat.txt 업데이트
14:30 - (사이클이 실행되어야 하나 정지됨)
...
15:00 - Watchdog: 프로세스 정지 감지 (60분 무응답)
15:00 - Watchdog: 자동 재시작
15:01 - 프로그램 재시작, 정상 작동 재개
```

### 날짜 변경 재시작 실패

```
00:00 - 날짜 변경
06:00 - (정상이면 자동 재시작해야 하나 실패)
...
05:55 - 작업 스케줄러: 강제 재시작
06:00 - 업무 시작, 정상 작동
```

## 예상 효과

✅ **중복 실행 방지** (V12.2): 프로세스 락으로 차단
✅ **프로세스 정지 감지** (V12.3): 60분 이내 자동 복구
✅ **일일 재시작 보장** (V12.3): 05:55 강제 재시작
✅ **로그 파일 관리**: 사이클당 새 로그 파일 (V12.2)
✅ **시스템 안정성**: 3단계 방어로 무중단 운영

## 선택 사항

### Watchdog 자동 시작

Watchdog도 작업 스케줄러에 등록하여 부팅 시 자동 시작:

**트리거**: 시스템 시작 시
**동작**: `pythonw watchdog.py`
**시작 위치**: `C:\Users\DSAI\Desktop\회계_ERP`

### 이메일 알림 추가

watchdog.py의 `kill_and_restart()` 함수에서:
```python
# 재시작 전 이메일 발송
notifier = NotifierModule()
notifier.send_error_notification(
    "프로세스 정지 감지 - 자동 재시작",
    f"마지막 업데이트: {time_diff} 전"
)
```

## 버전 정보

- **이전 버전**: V12.2 (프로세스 락)
- **현재 버전**: V12.3 (하트비트 + 자동 재시작)
- **주요 개선**:
  - Phase 2: 하트비트 모니터링
  - Phase 3: Windows 작업 스케줄러
  - 3단계 방어 시스템 완성

## 다음 단계

시스템이 안정적으로 작동하는지 모니터링:
1. 하루 동안 heartbeat.txt 업데이트 주기 확인
2. Watchdog 로그에서 이상 징후 확인
3. 작업 스케줄러 실행 기록 확인
4. 1주일 후 시스템 안정성 평가
